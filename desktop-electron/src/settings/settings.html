<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Synapse ç³»ç»Ÿè®¾ç½®</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Microsoft YaHei', 'Segoe UI', sans-serif;
        }

        body {
            background: linear-gradient(135deg, #0a0a0e 0%, #1a1a2e 100%);
            color: #ffffff;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .header {
            padding: 24px 40px;
            background: rgba(255, 255, 255, 0.03);
            border-bottom: 1px solid rgba(124, 77, 255, 0.3);
            backdrop-filter: blur(10px);
            -webkit-app-region: drag;
        }

        .header h1 {
            font-size: 22px;
            font-weight: 600;
            color: rgba(255, 255, 255, 0.95);
        }

        .header p {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.6);
            margin-top: 6px;
        }

        .container {
            flex: 1;
            padding: 30px;
            overflow-y: auto;
            display: grid;
            grid-template-columns: 480px 1fr;
            gap: 24px;
            max-width: 1600px;
            margin: 0 auto;
        }

        .left-panel {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .right-panel {
            display: flex;
            flex-direction: column;
        }

        .section {
            background: rgba(255, 255, 255, 0.04);
            border: 1px solid rgba(124, 77, 255, 0.2);
            border-radius: 16px;
            padding: 24px;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        .section-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 10px;
            color: #7C4DFF;
        }

        .section-subtitle {
            font-size: 13px;
            color: rgba(255, 255, 255, 0.5);
            margin-bottom: 16px;
        }

        .action-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .action-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 18px;
            background: rgba(0, 0, 0, 0.4);
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.08);
            transition: all 0.3s ease;
        }

        .action-row:hover {
            background: rgba(0, 0, 0, 0.5);
            border-color: rgba(124, 77, 255, 0.3);
            transform: translateX(4px);
        }

        .action-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .action-icon {
            font-size: 20px;
        }

        .action-text {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .action-label {
            font-size: 14px;
            font-weight: 500;
        }

        .action-desc {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.5);
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-primary {
            background: linear-gradient(135deg, #7C4DFF 0%, #9575FF 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(124, 77, 255, 0.4);
        }

        .btn-primary:hover:not(:disabled) {
            background: linear-gradient(135deg, #6A3DE8 0%, #8464EE 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(124, 77, 255, 0.5);
        }

        .btn-danger {
            background: linear-gradient(135deg, #F44336 0%, #E57373 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(244, 67, 54, 0.4);
        }

        .btn-danger:hover:not(:disabled) {
            background: linear-gradient(135deg, #D32F2F 0%, #EF5350 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(244, 67, 54, 0.5);
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }

        .btn-secondary:hover:not(:disabled) {
            background: rgba(255, 255, 255, 0.15);
        }

        .spinner {
            display: inline-block;
            width: 12px;
            height: 12px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* æ—¥å¿—åŒºåŸŸ */
        .logs-section {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .logs-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .logs-container {
            background: rgba(0, 0, 0, 0.6);
            border-radius: 12px;
            border: 1px solid rgba(124, 77, 255, 0.2);
            padding: 20px;
            flex: 1;
            overflow-y: auto;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.8;
            box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.4);
        }

        .log-line {
            color: rgba(255, 255, 255, 0.8);
            margin-bottom: 6px;
            padding: 4px 8px;
            border-radius: 4px;
            transition: background 0.2s;
        }

        .log-line:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .log-line.info {
            color: #66BB6A;
            border-left: 3px solid #66BB6A;
            padding-left: 8px;
        }
        .log-line.error {
            color: #EF5350;
            border-left: 3px solid #EF5350;
            padding-left: 8px;
        }
        .log-line.warning {
            color: #FFCA28;
            border-left: 3px solid #FFCA28;
            padding-left: 8px;
        }
        .log-line.system {
            color: #7C4DFF;
            border-left: 3px solid #7C4DFF;
            padding-left: 8px;
        }

        .log-filter {
            display: flex;
            gap: 8px;
        }

        .filter-btn {
            padding: 8px 16px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 6px;
            color: rgba(255, 255, 255, 0.7);
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
        }

        .filter-btn.active {
            background: linear-gradient(135deg, #7C4DFF 0%, #9575FF 100%);
            border-color: #7C4DFF;
            color: white;
            box-shadow: 0 4px 12px rgba(124, 77, 255, 0.4);
        }

        .filter-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(124, 77, 255, 0.5);
            transform: translateY(-2px);
        }

        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        /* Toast é€šçŸ¥ */
        .toast {
            position: fixed;
            top: 24px;
            right: 24px;
            padding: 14px 24px;
            background: rgba(0, 0, 0, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            font-size: 14px;
            font-weight: 500;
            z-index: 1000;
            opacity: 0;
            transform: translateX(400px);
            transition: all 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
        }

        .toast.show {
            opacity: 1;
            transform: translateX(0);
        }

        .toast.success {
            border-color: #66BB6A;
            box-shadow: 0 8px 32px rgba(102, 187, 106, 0.3);
        }

        .toast.error {
            border-color: #EF5350;
            box-shadow: 0 8px 32px rgba(239, 83, 80, 0.3);
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>âš™ï¸ ç³»ç»Ÿè®¾ç½® & æ§åˆ¶å°</h1>
        <p>è¿›ç¨‹ç®¡ç†ã€æ•°æ®æ¸…ç†ä¸ç³»ç»Ÿæ—¥å¿—ç›‘æ§</p>
    </div>

    <div class="container">
        <!-- å·¦ä¾§é¢æ¿ -->
        <div class="left-panel">
            <!-- è¿›ç¨‹æ§åˆ¶ -->
            <div class="section">
                <div class="section-title">ğŸ”§ è¿›ç¨‹æ§åˆ¶</div>
                <div class="section-subtitle">ç®¡ç†åç«¯æœåŠ¡çš„å¯åŠ¨ã€åœæ­¢å’Œé‡å¯</div>
                <div class="action-list">
                    <div class="action-row">
                        <div class="action-info">
                            <span class="action-icon">ğŸ”„</span>
                            <div class="action-text">
                                <span class="action-label">é‡å¯æ‰€æœ‰æœåŠ¡</span>
                                <span class="action-desc">Backend + Worker + Celery</span>
                            </div>
                        </div>
                        <button class="btn btn-primary" onclick="restartAll()">
                            <span id="restart-all-icon">é‡å¯</span>
                        </button>
                    </div>

                    <div class="action-row">
                        <div class="action-info">
                            <span class="action-icon">ğŸ”</span>
                            <div class="action-text">
                                <span class="action-label">é‡å¯åç«¯æœåŠ¡</span>
                                <span class="action-desc">FastAPI Backend</span>
                            </div>
                        </div>
                        <button class="btn btn-primary" onclick="restartBackend()">
                            <span id="restart-backend-icon">é‡å¯</span>
                        </button>
                    </div>

                    <div class="action-row">
                        <div class="action-info">
                            <span class="action-icon">ğŸ›‘</span>
                            <div class="action-text">
                                <span class="action-label">åœæ­¢æ‰€æœ‰æœåŠ¡</span>
                                <span class="action-desc">åœæ­¢æ‰€æœ‰åç«¯è¿›ç¨‹</span>
                            </div>
                        </div>
                        <button class="btn btn-danger" onclick="stopAll()">åœæ­¢</button>
                    </div>
                </div>
            </div>

            <!-- æ•°æ®æ¸…ç† -->
            <div class="section">
                <div class="section-title">ğŸ§¹ æ•°æ®æ¸…ç†</div>
                <div class="section-subtitle">æ¸…é™¤ç¼“å­˜ã€ç´ æã€è´¦å·ç­‰æ•°æ®</div>
                <div class="action-list">
                    <div class="action-row">
                        <div class="action-info">
                            <span class="action-icon">ğŸ“</span>
                            <div class="action-text">
                                <span class="action-label">æ¸…é™¤ç´ ææ•°æ®</span>
                                <span class="action-desc">åˆ é™¤æ‰€æœ‰æœ¬åœ°è§†é¢‘ç´ æ</span>
                            </div>
                        </div>
                        <button class="btn btn-secondary" onclick="clearMaterials()">æ¸…é™¤</button>
                    </div>

                    <div class="action-row">
                        <div class="action-info">
                            <span class="action-icon">ğŸª</span>
                            <div class="action-text">
                                <span class="action-label">æ¸…é™¤è´¦å· & Cookies</span>
                                <span class="action-desc">åˆ é™¤æ‰€æœ‰è´¦å·ç™»å½•ä¿¡æ¯</span>
                            </div>
                        </div>
                        <button class="btn btn-secondary" onclick="clearAccounts()">æ¸…é™¤</button>
                    </div>

                    <div class="action-row">
                        <div class="action-info">
                            <span class="action-icon">ğŸ—‘ï¸</span>
                            <div class="action-text">
                                <span class="action-label">æ¸…é™¤æ‰€æœ‰ç¼“å­˜</span>
                                <span class="action-desc">æ¸…ç©ºä¸´æ—¶æ–‡ä»¶å’Œç¼“å­˜</span>
                            </div>
                        </div>
                        <button class="btn btn-secondary" onclick="clearCache()">æ¸…é™¤</button>
                    </div>
                </div>
            </div>

            <!-- ç´§æ€¥æ“ä½œ -->
            <div class="section">
                <div class="section-title">âš ï¸ ç´§æ€¥æ“ä½œ</div>
                <div class="section-subtitle">ç³»ç»Ÿè‡ªæ£€ã€å¼ºåˆ¶ç»ˆæ­¢ä¸æ—¥å¿—å¯¼å‡º</div>
                <div class="action-list">
                    <div class="action-row">
                        <div class="action-info">
                            <span class="action-icon">ğŸ”</span>
                            <div class="action-text">
                                <span class="action-label">è¿è¡Œç³»ç»Ÿè‡ªæ£€</span>
                                <span class="action-desc">æ£€æŸ¥ç³»ç»Ÿå¥åº·çŠ¶æ€</span>
                            </div>
                        </div>
                        <button class="btn btn-primary" onclick="runSelfCheck()">è‡ªæ£€</button>
                    </div>

                    <div class="action-row">
                        <div class="action-info">
                            <span class="action-icon">ğŸ“¤</span>
                            <div class="action-text">
                                <span class="action-label">å¯¼å‡ºç³»ç»Ÿæ—¥å¿—</span>
                                <span class="action-desc">æ‰“åŒ…ä¸‹è½½æ‰€æœ‰æ—¥å¿—æ–‡ä»¶</span>
                            </div>
                        </div>
                        <button class="btn btn-primary" onclick="exportLogs()">å¯¼å‡º</button>
                    </div>

                    <div class="action-row">
                        <div class="action-info">
                            <span class="action-icon">âŒ</span>
                            <div class="action-text">
                                <span class="action-label">å¼ºåˆ¶ç»ˆæ­¢è¿›ç¨‹</span>
                                <span class="action-desc">ç«‹å³åœæ­¢æ‰€æœ‰æœåŠ¡</span>
                            </div>
                        </div>
                        <button class="btn btn-danger" onclick="forceKillProcesses()">ç»ˆæ­¢</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- å³ä¾§é¢æ¿ - æ—¥å¿—ç›‘æ§ -->
        <div class="right-panel">
            <div class="section logs-section">
                <div class="logs-header">
                    <div class="section-title">ğŸ“‹ å®æ—¶æ—¥å¿—ç›‘æ§</div>
                    <div class="log-filter">
                        <button class="filter-btn active" data-filter="all" onclick="setLogFilter('all')">å…¨éƒ¨</button>
                        <button class="filter-btn" data-filter="info" onclick="setLogFilter('info')">ä¿¡æ¯</button>
                        <button class="filter-btn" data-filter="error" onclick="setLogFilter('error')">é”™è¯¯</button>
                        <button class="filter-btn" data-filter="warning" onclick="setLogFilter('warning')">è­¦å‘Š</button>
                        <button class="btn btn-secondary" onclick="refreshLogs()" style="padding: 6px 12px; font-size: 12px;">
                            <span id="refresh-icon">ğŸ”„</span> åˆ·æ–°
                        </button>
                    </div>
                </div>
                <div class="logs-container" id="logs">
                    <div class="log-line system">ç­‰å¾…æ—¥å¿—åŠ è½½...</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://127.0.0.1:7000/api/v1/system';
        let currentLogFilter = 'all';
        let autoRefreshInterval = null;

        // Toast é€šçŸ¥
        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            document.body.appendChild(toast);

            setTimeout(() => toast.classList.add('show'), 10);
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // ========== è¿›ç¨‹æ§åˆ¶ ==========

        async function restartAll() {
            const btn = document.querySelector('#restart-all-icon');
            const originalText = btn.textContent;
            btn.innerHTML = '<span class="spinner"></span>';

            try {
                const response = await fetch(`${API_BASE}/supervisor/restart`, { method: 'POST' });
                const data = await response.json();

                if (response.ok) {
                    showToast('âœ… æ‰€æœ‰æœåŠ¡å·²é‡å¯', 'success');
                    addLog('ç³»ç»Ÿ', 'æ‰€æœ‰æœåŠ¡é‡å¯æˆåŠŸ');
                } else {
                    throw new Error(data.detail || 'é‡å¯å¤±è´¥');
                }
            } catch (error) {
                showToast('âŒ é‡å¯å¤±è´¥: ' + error.message, 'error');
                addLog('é”™è¯¯', 'é‡å¯å¤±è´¥: ' + error.message);
            } finally {
                btn.textContent = originalText;
            }
        }

        async function restartBackend() {
            const btn = document.querySelector('#restart-backend-icon');
            const originalText = btn.textContent;
            btn.innerHTML = '<span class="spinner"></span>';

            try {
                const response = await fetch(`${API_BASE}/supervisor/restart/backend`, { method: 'POST' });
                const data = await response.json();

                if (response.ok) {
                    showToast('âœ… åç«¯æœåŠ¡å·²é‡å¯', 'success');
                    addLog('ç³»ç»Ÿ', 'åç«¯æœåŠ¡é‡å¯æˆåŠŸ');
                } else {
                    throw new Error(data.detail || 'é‡å¯å¤±è´¥');
                }
            } catch (error) {
                showToast('âŒ é‡å¯å¤±è´¥: ' + error.message, 'error');
                addLog('é”™è¯¯', 'é‡å¯å¤±è´¥: ' + error.message);
            } finally {
                btn.textContent = originalText;
            }
        }

        async function stopAll() {
            if (!confirm('ç¡®è®¤åœæ­¢æ‰€æœ‰æœåŠ¡ï¼Ÿ')) return;

            try {
                const response = await fetch(`${API_BASE}/supervisor/stop`, { method: 'POST' });
                const data = await response.json();

                if (response.ok) {
                    showToast('ğŸ›‘ æ‰€æœ‰æœåŠ¡å·²åœæ­¢', 'success');
                    addLog('ç³»ç»Ÿ', 'æ‰€æœ‰æœåŠ¡å·²åœæ­¢');
                } else {
                    throw new Error(data.detail || 'åœæ­¢å¤±è´¥');
                }
            } catch (error) {
                showToast('âŒ åœæ­¢å¤±è´¥: ' + error.message, 'error');
                addLog('é”™è¯¯', 'åœæ­¢å¤±è´¥: ' + error.message);
            }
        }

        // ========== æ•°æ®æ¸…ç† ==========

        async function clearMaterials() {
            if (!confirm('ç¡®è®¤æ¸…é™¤æ‰€æœ‰ç´ ææ•°æ®ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) return;

            try {
                const response = await fetch(`${API_BASE}/clear-materials`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ backup: false })
                });

                if (response.ok) {
                    showToast('âœ… ç´ ææ•°æ®å·²æ¸…é™¤', 'success');
                    addLog('ç³»ç»Ÿ', 'ç´ ææ•°æ®æ¸…é™¤æˆåŠŸ');
                } else {
                    const data = await response.json();
                    throw new Error(data.detail || 'æ¸…é™¤å¤±è´¥');
                }
            } catch (error) {
                showToast('âŒ æ¸…é™¤å¤±è´¥: ' + error.message, 'error');
                addLog('é”™è¯¯', 'æ¸…é™¤å¤±è´¥: ' + error.message);
            }
        }

        async function clearAccounts() {
            if (!confirm('ç¡®è®¤æ¸…é™¤æ‰€æœ‰è´¦å·å’Œ Cookiesï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) return;

            try {
                const response = await fetch(`${API_BASE}/clear-accounts`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ backup: false })
                });

                if (response.ok) {
                    showToast('âœ… è´¦å·æ•°æ®å·²æ¸…é™¤', 'success');
                    addLog('ç³»ç»Ÿ', 'è´¦å·ä¸ Cookies æ¸…é™¤æˆåŠŸ');
                } else {
                    const data = await response.json();
                    throw new Error(data.detail || 'æ¸…é™¤å¤±è´¥');
                }
            } catch (error) {
                showToast('âŒ æ¸…é™¤å¤±è´¥: ' + error.message, 'error');
                addLog('é”™è¯¯', 'æ¸…é™¤å¤±è´¥: ' + error.message);
            }
        }

        async function clearCache() {
            if (!confirm('ç¡®è®¤æ¸…é™¤æ‰€æœ‰ç¼“å­˜ï¼Ÿ')) return;

            try {
                const response = await fetch(`${API_BASE}/clear-cache`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ backup: false })
                });

                if (response.ok) {
                    showToast('âœ… ç¼“å­˜å·²æ¸…é™¤', 'success');
                    addLog('ç³»ç»Ÿ', 'ç¼“å­˜æ¸…é™¤æˆåŠŸ');
                } else {
                    const data = await response.json();
                    throw new Error(data.detail || 'æ¸…é™¤å¤±è´¥');
                }
            } catch (error) {
                showToast('âŒ æ¸…é™¤å¤±è´¥: ' + error.message, 'error');
                addLog('é”™è¯¯', 'æ¸…é™¤å¤±è´¥: ' + error.message);
            }
        }

        // ========== ç´§æ€¥æ“ä½œ ==========

        async function runSelfCheck() {
            try {
                const response = await fetch(`${API_BASE}/self-check`, { method: 'POST' });
                const data = await response.json();

                if (data.status === 'success') {
                    showToast('âœ… ç³»ç»Ÿè‡ªæ£€é€šè¿‡', 'success');
                    addLog('ç³»ç»Ÿ', 'ç³»ç»Ÿè‡ªæ£€é€šè¿‡ï¼Œä¸€åˆ‡æ­£å¸¸');
                } else if (data.status === 'warning') {
                    showToast('âš ï¸ å‘ç°é—®é¢˜: ' + data.issues.join(', '), 'error');
                    data.issues.forEach(issue => addLog('è­¦å‘Š', issue));
                }
            } catch (error) {
                showToast('âŒ è‡ªæ£€å¤±è´¥: ' + error.message, 'error');
                addLog('é”™è¯¯', 'è‡ªæ£€å¤±è´¥: ' + error.message);
            }
        }

        async function exportLogs() {
            try {
                const response = await fetch(`${API_BASE}/export-logs`, { method: 'POST' });

                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `synapse-logs-${new Date().toISOString().split('T')[0]}.zip`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);

                    showToast('âœ… æ—¥å¿—å·²å¯¼å‡º', 'success');
                    addLog('ç³»ç»Ÿ', 'ç³»ç»Ÿæ—¥å¿—å¯¼å‡ºæˆåŠŸ');
                } else {
                    throw new Error('å¯¼å‡ºå¤±è´¥');
                }
            } catch (error) {
                showToast('âŒ å¯¼å‡ºå¤±è´¥: ' + error.message, 'error');
                addLog('é”™è¯¯', 'å¯¼å‡ºå¤±è´¥: ' + error.message);
            }
        }

        async function forceKillProcesses() {
            if (!confirm('ç¡®è®¤å¼ºåˆ¶ç»ˆæ­¢æ‰€æœ‰è¿›ç¨‹ï¼Ÿ')) return;

            try {
                const response = await fetch(`${API_BASE}/supervisor/stop`, { method: 'POST' });

                if (response.ok) {
                    showToast('âœ… è¿›ç¨‹å·²å¼ºåˆ¶ç»ˆæ­¢', 'success');
                    addLog('ç³»ç»Ÿ', 'æ‰€æœ‰è¿›ç¨‹å·²å¼ºåˆ¶ç»ˆæ­¢');
                } else {
                    throw new Error('ç»ˆæ­¢å¤±è´¥');
                }
            } catch (error) {
                showToast('âŒ ç»ˆæ­¢å¤±è´¥: ' + error.message, 'error');
                addLog('é”™è¯¯', 'ç»ˆæ­¢å¤±è´¥: ' + error.message);
            }
        }

        // ========== æ—¥å¿—ç®¡ç† ==========

        function addLog(type, message) {
            const logs = document.getElementById('logs');
            const line = document.createElement('div');
            const typeClass = type === 'ç³»ç»Ÿ' ? 'system' : type === 'é”™è¯¯' ? 'error' : type === 'è­¦å‘Š' ? 'warning' : 'info';
            line.className = `log-line ${typeClass}`;
            const time = new Date().toLocaleTimeString();
            line.textContent = `[${time}] [${type}] ${message}`;
            logs.appendChild(line);
            logs.scrollTop = logs.scrollHeight;

            // é™åˆ¶æ—¥å¿—æ•°é‡
            while (logs.children.length > 500) {
                logs.removeChild(logs.firstChild);
            }
        }

        async function refreshLogs() {
            const icon = document.getElementById('refresh-icon');
            icon.textContent = 'ğŸ”„';

            try {
                const response = await fetch(`${API_BASE}/logs?lines=100`);
                const data = await response.json();

                if (data.status === 'success' && data.lines) {
                    const logs = document.getElementById('logs');
                    logs.innerHTML = '';

                    data.lines.forEach(line => {
                        const div = document.createElement('div');
                        div.className = 'log-line';

                        // ç®€å•çš„æ—¥å¿—ç±»å‹æ£€æµ‹
                        if (line.includes('ERROR') || line.includes('error')) {
                            div.classList.add('error');
                        } else if (line.includes('WARNING') || line.includes('warning')) {
                            div.classList.add('warning');
                        } else if (line.includes('INFO')) {
                            div.classList.add('info');
                        }

                        div.textContent = line;
                        logs.appendChild(div);
                    });

                    logs.scrollTop = logs.scrollHeight;
                    showToast('âœ… æ—¥å¿—å·²åˆ·æ–°', 'success');
                } else {
                    addLog('è­¦å‘Š', 'æš‚æ— æ—¥å¿—æ•°æ®');
                }
            } catch (error) {
                addLog('é”™è¯¯', 'åˆ·æ–°æ—¥å¿—å¤±è´¥: ' + error.message);
            } finally {
                icon.textContent = 'ğŸ”„';
            }
        }

        function setLogFilter(filter) {
            currentLogFilter = filter;
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.filter === filter);
            });

            const logs = document.querySelectorAll('.log-line');
            logs.forEach(log => {
                if (filter === 'all') {
                    log.style.display = 'block';
                } else {
                    log.style.display = log.classList.contains(filter) ? 'block' : 'none';
                }
            });
        }

        // åˆå§‹åŒ–
        window.addEventListener('DOMContentLoaded', () => {
            addLog('ç³»ç»Ÿ', 'è®¾ç½®é¡µé¢å·²å°±ç»ª');
            refreshLogs();

            // æ¯ 30 ç§’è‡ªåŠ¨åˆ·æ–°æ—¥å¿—
            autoRefreshInterval = setInterval(refreshLogs, 30000);
        });

        // é¡µé¢å¸è½½æ—¶æ¸…ç†
        window.addEventListener('beforeunload', () => {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
            }
        });
    </script>
</body>
</html>
